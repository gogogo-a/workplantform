# API æ¥å£æ£€æŸ¥æŠ¥å‘Š

> æ—¥æœŸï¼š2024-10-24  
> çŠ¶æ€ï¼šâœ… å·²ä¿®å¤æ‰€æœ‰ä¸ä¸€è‡´é—®é¢˜

---

## âœ… æ£€æŸ¥ç»“æœæ€»è§ˆ

| æ¨¡å— | æ¥å£æ•°é‡ | çŠ¶æ€ | å¤‡æ³¨ |
|------|---------|------|------|
| ç”¨æˆ·ç®¡ç† | 10 ä¸ª | âœ… å·²éªŒè¯ | å­—æ®µåå·²ä¿®æ­£ï¼Œæ–°å¢2ä¸ªæ¥å£ |
| æ–‡æ¡£ç®¡ç† | 4 ä¸ª | âœ… å·²éªŒè¯ | å®Œå…¨ä¸€è‡´ |
| ä¼šè¯ç®¡ç† | 3 ä¸ª | âœ… å·²éªŒè¯ | å®Œå…¨ä¸€è‡´ |
| æ¶ˆæ¯ç®¡ç† | 2 ä¸ª | âœ… å·²éªŒè¯ | SSE æµå¼å·²å®ç° |

---

## ğŸ†• æ–°å¢çš„åç«¯æ¥å£

### 1. æ‰¹é‡åˆ é™¤ç”¨æˆ· (`DELETE /users/{user_id_list}`)

**è¯´æ˜**ï¼šæ”¯æŒä¸€æ¬¡åˆ é™¤å¤šä¸ªç”¨æˆ·

**å®ç°ä½ç½®**ï¼š
- **Controller**: `api/v1/user_info_controller.py:169-193`
- **Service**: `internal/service/orm/user_info_sever.py:233-251`
- **Request DTO**: `internal/dto/request/user_request.py` (æ— éœ€é¢å¤–DTOï¼Œä½¿ç”¨è·¯å¾„å‚æ•°)

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
// å‰ç«¯è°ƒç”¨
deleteUsers(['uuid1', 'uuid2', 'uuid3'])

// å®é™…è¯·æ±‚
DELETE /users/uuid1,uuid2,uuid3
```

---

### 2. è®¾ç½®ç®¡ç†å‘˜ (`PATCH /users/set-admin`)

**è¯´æ˜**ï¼šè®¾ç½®æˆ–å–æ¶ˆç”¨æˆ·çš„ç®¡ç†å‘˜æƒé™

**å®ç°ä½ç½®**ï¼š
- **Controller**: `api/v1/user_info_controller.py:196-222`
- **Service**: `internal/service/orm/user_info_sever.py:253-273`
- **Request DTO**: `internal/dto/request/user_request.py:44-47` (`SetAdminRequest`)

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
// å‰ç«¯è°ƒç”¨
setAdmin({
  user_id: 'uuid',
  is_admin: true
})

// å®é™…è¯·æ±‚
PATCH /users/set-admin
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "is_admin": true
}
```

---

## ğŸ”§ å·²ä¿®å¤çš„é—®é¢˜

### 1. ç”¨æˆ·æ³¨å†Œæ¥å£ (`POST /users`)

**é—®é¢˜**ï¼šå­—æ®µåä¸ä¸€è‡´

**ä¿®å¤å‰**ï¼š
```javascript
{
  nickname: form.nickname,
  email: form.email,
  verification_code: form.code,  // âŒ é”™è¯¯çš„å­—æ®µå
  password: form.password
  // âŒ ç¼ºå°‘ confirm_password
}
```

**ä¿®å¤å**ï¼š
```javascript
{
  nickname: form.nickname,
  email: form.email,
  captcha: form.code,              // âœ… æ­£ç¡®
  password: form.password,
  confirm_password: form.confirmPassword  // âœ… å·²æ·»åŠ 
}
```

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/login/RegisterForm.vue:194-200`

---

### 2. é‚®ç®±éªŒè¯ç ç™»å½•æ¥å£ (`POST /users/email-login`)

**é—®é¢˜**ï¼šéªŒè¯ç å­—æ®µåä¸ä¸€è‡´

**ä¿®å¤å‰**ï¼š
```javascript
emailForm  // ç›´æ¥ä¼ é€’ï¼Œcode å­—æ®µä¼šè¢«ä¼ é€’
```

**ä¿®å¤å**ï¼š
```javascript
{
  email: emailForm.email,
  captcha: emailForm.code  // âœ… æ˜ç¡®æ˜ å°„ä¸º captcha
}
```

**æ–‡ä»¶ä½ç½®**ï¼š`src/components/login/LoginForm.vue:194-197`

---

## âœ… å·²éªŒè¯æ­£ç¡®çš„æ¥å£

### ç”¨æˆ·ç®¡ç† API

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | å‰ç«¯å®ç° | çŠ¶æ€ |
|------|------|------|---------|------|
| ç”¨æˆ·æ³¨å†Œ | POST | `/users` | `register()` | âœ… å·²ä¿®å¤ |
| ç”¨æˆ·ç™»å½• | POST | `/users/login` | `login()` | âœ… æ­£ç¡® |
| é‚®ç®±éªŒè¯ç ç™»å½• | POST | `/users/email-login` | `emailLogin()` | âœ… å·²ä¿®å¤ |
| å‘é€é‚®ç®±éªŒè¯ç  | POST | `/users/email-code` | `sendEmailCode()` | âœ… æ­£ç¡® |
| è·å–ç”¨æˆ·ä¿¡æ¯ | GET | `/users/{user_id}` | `getUserInfo()` | âœ… æ­£ç¡® |
| æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | PATCH | `/users/{user_id}` | `updateUserInfo()` | âœ… æ­£ç¡® |
| è·å–ç”¨æˆ·åˆ—è¡¨ | GET | `/users` | `getUserList()` | âœ… æ­£ç¡® |
| åˆ é™¤å•ä¸ªç”¨æˆ· | DELETE | `/users/{user_id}` | `deleteUsers([id])` | âœ… æ­£ç¡® |
| æ‰¹é‡åˆ é™¤ç”¨æˆ· | DELETE | `/users/{user_id_list}` | `deleteUsers()` | âœ… æ­£ç¡®ï¼ˆæ–°å¢ï¼‰ |
| è®¾ç½®ç®¡ç†å‘˜ | PATCH | `/users/set-admin` | `setAdmin()` | âœ… æ­£ç¡®ï¼ˆæ–°å¢ï¼‰ |

### æ–‡æ¡£ç®¡ç† API

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | å‰ç«¯å®ç° | çŠ¶æ€ |
|------|------|------|---------|------|
| ä¸Šä¼ æ–‡æ¡£ | POST | `/documents` | `uploadDocument()` | âœ… æ­£ç¡® |
| è·å–æ–‡æ¡£åˆ—è¡¨ | GET | `/documents` | `getDocumentList()` | âœ… æ­£ç¡® |
| è·å–æ–‡æ¡£è¯¦æƒ… | GET | `/documents/{document_id}` | `getDocumentDetail()` | âœ… æ­£ç¡® |
| åˆ é™¤æ–‡æ¡£ | DELETE | `/documents/{document_id}` | `deleteDocument()` | âœ… æ­£ç¡® |

### ä¼šè¯ç®¡ç† API

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | å‰ç«¯å®ç° | çŠ¶æ€ |
|------|------|------|---------|------|
| è·å–ä¼šè¯åˆ—è¡¨ | GET | `/sessions` | `getSessionList()` | âœ… æ­£ç¡® |
| è·å–ä¼šè¯è¯¦æƒ… | GET | `/sessions/{session_id}` | `getSessionDetail()` | âœ… æ­£ç¡® |
| æ›´æ–°ä¼šè¯ä¿¡æ¯ | PATCH | `/sessions/{session_id}` | `updateSession()` | âœ… æ­£ç¡® |

### æ¶ˆæ¯ç®¡ç† API

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | å‰ç«¯å®ç° | çŠ¶æ€ |
|------|------|------|---------|------|
| å‘é€æ¶ˆæ¯ï¼ˆæµå¼ï¼‰ | POST | `/messages` | `sendMessageStream()` | âœ… æ­£ç¡®ï¼ˆSSEï¼‰ |
| è·å–ä¼šè¯æ¶ˆæ¯ | GET | `/messages/{session_id}` | `getMessageList()` | âœ… æ­£ç¡® |

---

## ğŸ“‹ SSE æµå¼æ¶ˆæ¯éªŒè¯

### äº‹ä»¶ç±»å‹æ˜ å°„

| API æ–‡æ¡£äº‹ä»¶ | å‰ç«¯å¤„ç† | çŠ¶æ€ |
|-------------|---------|------|
| `session_created` | âœ… å·²å¤„ç† | æ­£ç¡® |
| `user_message_saved` | âœ… å·²å¤„ç† | æ­£ç¡® |
| `thought` | âœ… å·²å¤„ç† | æ­£ç¡®ï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰ |
| `action` | âœ… å·²å¤„ç† | æ­£ç¡®ï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰ |
| `observation` | âœ… å·²å¤„ç† | æ­£ç¡®ï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰ |
| `answer_chunk` | âœ… å·²å¤„ç† | æ­£ç¡®ï¼ˆå®æ—¶è¾“å‡ºï¼‰ |
| `ai_message_saved` | âœ… å·²å¤„ç† | æ­£ç¡® |
| `done` | âœ… å·²å¤„ç† | æ­£ç¡® |
| `error` | âœ… å·²å¤„ç† | æ­£ç¡® |

### å®ç°ä½ç½®
- **API è°ƒç”¨**ï¼š`src/api/message.js:22-35`
- **SSE å¤„ç†**ï¼š`src/views/chat/ChatView.vue:95-149`
- **äº‹ä»¶åˆ†å‘**ï¼š`src/views/chat/ChatView.vue:152-178`

---

## ğŸ¯ è¯·æ±‚å‚æ•°éªŒè¯

### æ³¨å†Œæ¥å£å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | å‰ç«¯éªŒè¯ | API éªŒè¯ | çŠ¶æ€ |
|--------|------|------|---------|---------|------|
| nickname | string | âœ… | âœ… 2-20å­—ç¬¦ | âœ… 2-50å­—ç¬¦ | âœ… |
| email | string | âœ… | âœ… é‚®ç®±æ ¼å¼ | âœ… é‚®ç®±æ ¼å¼ | âœ… |
| captcha | string | âœ… | âœ… 6ä½ | âœ… 6ä½ | âœ… |
| password | string | âœ… | âœ… â‰¥6ä½ | âœ… â‰¥6ä½ | âœ… |
| confirm_password | string | âœ… | âœ… ä¸€è‡´æ€§ | âœ… ä¸€è‡´æ€§ | âœ… |

### æ¶ˆæ¯å‘é€å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | å‰ç«¯å®ç° | API è¦æ±‚ | çŠ¶æ€ |
|--------|------|------|---------|---------|------|
| content | string | âœ… | âœ… | âœ… | âœ… |
| user_id | string | âœ… | âœ… | âœ… | âœ… |
| session_id | string | âŒ | âœ… å¯é€‰ | âœ… å¯é€‰ | âœ… |
| show_thinking | boolean | âŒ | âœ… | âœ… | âœ… |

---

## ğŸ” è®¤è¯å’Œæˆæƒ

### Token å¤„ç†

| åŠŸèƒ½ | å®ç°ä½ç½® | çŠ¶æ€ |
|------|---------|------|
| Token å­˜å‚¨ | `localStorage` | âœ… |
| è¯·æ±‚å¤´æ·»åŠ  | `request.js:19-22` | âœ… |
| Token è¿‡æœŸå¤„ç† | `request.js:43-51` | âœ… |
| è‡ªåŠ¨è·³è½¬ç™»å½• | `request.js:49` | âœ… |

### è·¯ç”±å®ˆå«

| åŠŸèƒ½ | å®ç°ä½ç½® | çŠ¶æ€ |
|------|---------|------|
| ç™»å½•çŠ¶æ€æ£€æŸ¥ | `router/index.js:66-72` | âœ… |
| ç®¡ç†å‘˜æƒé™æ£€æŸ¥ | `router/index.js:74-79` | âœ… |
| è‡ªåŠ¨é‡å®šå‘ | `router/index.js:83-87` | âœ… |

---

## ğŸ“ å“åº”æ ¼å¼éªŒè¯

### æ ‡å‡† JSON å“åº”

```javascript
{
  "code": 0,           // âœ… å·²å¤„ç†
  "message": "æˆåŠŸ",   // âœ… å·²æ˜¾ç¤º
  "data": {}          // âœ… å·²è¿”å›
}
```

**æ‹¦æˆªå™¨å¤„ç†**ï¼š`src/api/request.js:33-45`

### SSE æµå¼å“åº”

```
event: <type>        // âœ… å·²è§£æ
data: <json>         // âœ… å·²è§£æ

```

**å¤„ç†é€»è¾‘**ï¼š`src/views/chat/ChatView.vue:117-142`

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. ç”¨æˆ·æ³¨å†Œæµç¨‹

```bash
# æµ‹è¯•æ­¥éª¤
1. è®¿é—® /register
2. å¡«å†™è¡¨å•ï¼ˆæ˜µç§°ã€é‚®ç®±ã€å¯†ç ã€ç¡®è®¤å¯†ç ï¼‰
3. ç‚¹å‡»"å‘é€éªŒè¯ç "
4. è¾“å…¥éªŒè¯ç 
5. ç‚¹å‡»"æ³¨å†Œ"

# é¢„æœŸç»“æœ
âœ… éªŒè¯ç å‘é€æˆåŠŸ
âœ… æ³¨å†ŒæˆåŠŸå¹¶è·³è½¬åˆ°ç™»å½•é¡µ
âœ… æ‰€æœ‰å­—æ®µéªŒè¯æ­£ç¡®
```

### 2. æµå¼æ¶ˆæ¯æµ‹è¯•

```bash
# æµ‹è¯•æ­¥éª¤
1. ç™»å½•ç³»ç»Ÿ
2. è¿›å…¥èŠå¤©é¡µé¢
3. è¾“å…¥é—®é¢˜ï¼š"ä»€ä¹ˆæ˜¯ RAG æŠ€æœ¯ï¼Ÿ"
4. åˆ‡æ¢"æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹"å¼€å…³
5. è§‚å¯Ÿå®æ—¶è¾“å‡º

# é¢„æœŸç»“æœ
âœ… Token-by-Token å®æ—¶æ˜¾ç¤º
âœ… æ€è€ƒè¿‡ç¨‹å¯é€‰æ˜¾ç¤º/éšè—
âœ… è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
âœ… ä¼šè¯è‡ªåŠ¨åˆ›å»ºå’Œæ›´æ–°
```

### 3. ç®¡ç†åå°æµ‹è¯•

```bash
# æµ‹è¯•æ­¥éª¤ï¼ˆéœ€è¦ç®¡ç†å‘˜è´¦æˆ·ï¼‰
1. ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•
2. è®¿é—® /admin/users
3. æœç´¢ç”¨æˆ·
4. è®¾ç½®ç®¡ç†å‘˜æƒé™
5. è®¿é—® /admin/documents
6. ä¸Šä¼ æ–‡æ¡£
7. åˆ é™¤æ–‡æ¡£

# é¢„æœŸç»“æœ
âœ… æƒé™æ§åˆ¶æ­£ç¡®
âœ… æœç´¢åŠŸèƒ½æ­£å¸¸
âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸
âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
```

---

## âœ… æ€»ç»“

### æ–°å¢åç«¯æ¥å£ï¼ˆ2ä¸ªï¼‰
1. âœ… æ‰¹é‡åˆ é™¤ç”¨æˆ·æ¥å£ (`DELETE /users/{user_id_list}`)
2. âœ… è®¾ç½®ç®¡ç†å‘˜æ¥å£ (`PATCH /users/set-admin`)

### ä¿®å¤å†…å®¹ï¼ˆ3å¤„ï¼‰
1. âœ… ä¿®å¤æ³¨å†Œæ¥å£å­—æ®µåï¼ˆ`verification_code` â†’ `captcha`ï¼‰
2. âœ… æ·»åŠ æ³¨å†Œæ¥å£ç¼ºå¤±å­—æ®µï¼ˆ`confirm_password`ï¼‰
3. âœ… ä¿®å¤é‚®ç®±ç™»å½•æ¥å£å­—æ®µåï¼ˆæ˜¾å¼æ˜ å°„ä¸º `captcha`ï¼‰

### å®Œæ•´éªŒè¯ç»“æœ
- âœ… **19 ä¸ª API æ¥å£**å…¨éƒ¨å®ç°å¹¶éªŒè¯
- âœ… æ‰€æœ‰ API æ¥å£è·¯å¾„æ­£ç¡®
- âœ… æ‰€æœ‰è¯·æ±‚æ–¹æ³•æ­£ç¡®  
- âœ… æ‰€æœ‰å‚æ•°å­—æ®µåæ­£ç¡®
- âœ… SSE æµå¼æ¶ˆæ¯å®Œå…¨å®ç°
- âœ… è®¤è¯å’Œæˆæƒæœºåˆ¶å®Œæ•´
- âœ… å“åº”æ ¼å¼å¤„ç†æ­£ç¡®
- âœ… éµå¾ª API å¼€å‘è§„èŒƒ

### å¼€å‘æœåŠ¡å™¨çŠ¶æ€
- âœ… å‰ç«¯ï¼šhttp://localhost:5173
- âœ… åç«¯ï¼šhttp://localhost:8000
- âœ… API æ–‡æ¡£ï¼šhttp://localhost:8000/docs

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚å‘ç°ä»»ä½• API æ¥å£é—®é¢˜ï¼Œè¯·åŠæ—¶åé¦ˆã€‚

**æœ€åæ›´æ–°**ï¼š2024-10-24  
**æ£€æŸ¥äººå‘˜**ï¼šAI Assistant  
**çŠ¶æ€**ï¼šâœ… æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼Œæ–°å¢2ä¸ªåç«¯æ¥å£  
**æ¥å£æ€»æ•°**ï¼š19 ä¸ªï¼ˆç”¨æˆ·ç®¡ç†10ä¸ª + æ–‡æ¡£ç®¡ç†4ä¸ª + ä¼šè¯ç®¡ç†3ä¸ª + æ¶ˆæ¯ç®¡ç†2ä¸ªï¼‰

