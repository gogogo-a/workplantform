# æ— äººç³»ç»Ÿäº‘ç«¯ RAG åº”ç”¨

åŸºäº**æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰**æŠ€æœ¯çš„ä¼ä¸šçº§æ™ºèƒ½é—®ç­”ç³»ç»Ÿï¼Œä¸“æ³¨äºæ— äººç³»ç»Ÿé¢†åŸŸçš„çŸ¥è¯†åº“æ„å»ºä¸æ™ºèƒ½æ£€ç´¢ã€‚

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ—¨åœ¨æ„å»ºä¸€å¥—é«˜æ€§èƒ½çš„äº‘ç«¯çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿï¼Œé€šè¿‡ RAG æŠ€æœ¯å®ç°ï¼š
- ğŸ“š å¤§è§„æ¨¡æ–‡æ¡£çš„æ™ºèƒ½æ£€ç´¢
- ğŸ¤– ç²¾å‡†çš„ AI é—®ç­”
- ğŸ” å¯æº¯æºçš„ç­”æ¡ˆç”Ÿæˆ
- âš¡ é«˜æ€§èƒ½çš„å‘é‡æ£€ç´¢

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æ ¸å¿ƒåŸºç¡€æ¶æ„

#### 1.1 æ•°æ®åº“å±‚
- âœ… **MongoDB é›†æˆ**
  - åŸºäº Beanie ODM çš„å¼‚æ­¥æ–‡æ¡£æ˜ å°„
  - å•ä¾‹è¿æ¥æ¨¡å¼ï¼Œæ”¯æŒè¿æ¥æ± 
  - æ•°æ®æ¨¡å‹ï¼š`DocumentModel`ï¼ˆæ–‡æ¡£ï¼‰ã€`MessageModel`ï¼ˆæ¶ˆæ¯ï¼‰ã€`UserInfoModel`ï¼ˆç”¨æˆ·ï¼‰
  - å®Œæ•´çš„ CRUD æ“ä½œæ”¯æŒ

- âœ… **Milvus å‘é‡æ•°æ®åº“**
  - å•ä¾‹è¿æ¥ç®¡ç†
  - æ”¯æŒé›†åˆåˆ›å»ºã€åˆ é™¤ã€æŸ¥è¯¢
  - COSINE ç›¸ä¼¼åº¦æ£€ç´¢
  - Docker Compose ä¸€é”®éƒ¨ç½²ï¼ˆåŒ…å« MinIOã€Attu å¯è§†åŒ–å·¥å…·ï¼‰
  - 1024ç»´å‘é‡å­˜å‚¨

#### 1.2 ç»Ÿä¸€æ¨¡å‹ç®¡ç†ç³»ç»Ÿ
- âœ… **æ¨¡å‹é…ç½®æ¶æ„**
  - åŸºäºç»§æ‰¿çš„æ¨¡å‹é…ç½®åŸºç±»ï¼ˆ`BaseModelConfig`ï¼‰
  - åˆ†ç±»ç®¡ç†ï¼šLLMã€Embeddingã€Reranker
  - ç»Ÿä¸€çš„ `ModelManager` ç®¡ç†å™¨
  - æ”¯æŒæœ¬åœ°æ¨¡å‹ï¼ˆ`type: "local"`ï¼‰å’Œäº‘ç«¯æ¨¡å‹ï¼ˆ`type: "cloud"`ï¼‰

- âœ… **å·²é›†æˆæ¨¡å‹**
  - **LLM**: Ollama Llama 3.2ï¼ˆæœ¬åœ°ï¼‰ã€DeepSeek Chatï¼ˆäº‘ç«¯ï¼‰
  - **Embedding**: BGE-large-zh-v1.5ï¼ˆ1024ç»´ï¼‰ã€BGE-base-zh-v1.5ã€Text2vec-base-chinese
  - **Reranker**: BGE-reranker-v2-m3ã€BGE-reranker-largeã€BGE-reranker-base

### 2. æ ¸å¿ƒæœåŠ¡å±‚

#### 2.1 LLM æœåŠ¡ï¼ˆ`internal/llm/llm_service.py`ï¼‰
- âœ… **æ¨¡å‹è°ƒç”¨**
  - ç»Ÿä¸€çš„ LLM æ¥å£ï¼Œæ”¯æŒæœ¬åœ°å’Œäº‘ç«¯æ¨¡å‹åˆ‡æ¢
  - ç®€åŒ– APIï¼šæ”¯æŒ `user_message`ï¼ˆæ¨èï¼‰å’Œ `messages`ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
  - è‡ªåŠ¨å†å²è®°å½•ç®¡ç†ï¼ˆ`use_history=True`ï¼‰
  - æµå¼å’Œéæµå¼å¯¹è¯æ”¯æŒ
  
- âœ… **é«˜çº§åŠŸèƒ½**
  - ç³»ç»Ÿ Prompt ç®¡ç†
  - å·¥å…·è°ƒç”¨èƒ½åŠ›ï¼ˆTool Useï¼‰
  - å»¶è¿Ÿæ€»ç»“æœºåˆ¶ï¼šåœ¨ä¸‹æ¬¡å¯¹è¯å‰è‡ªåŠ¨æ‰§è¡Œæ€»ç»“
    - è§¦å‘æ¡ä»¶ï¼šæ¶ˆæ¯æ•° >= 10 æˆ– token æ•°è¶…è¿‡é˜ˆå€¼
    - åŒæ­¥æ‰§è¡Œï¼ˆ`summarize_history()`ï¼‰
    - è‡ªåŠ¨æ›¿æ¢å†å²è®°å½•
  - å‚æ•°éªŒè¯ï¼šç¦æ­¢åŒæ—¶ä¼ é€’ `user_message` å’Œ `messages`

#### 2.2 ChatService ä¼šè¯æœåŠ¡ï¼ˆ`internal/chat_service/chat_service.py`ï¼‰ğŸ†•
- âœ… **ç»Ÿä¸€ä¼šè¯ç®¡ç†**
  - Session å’Œ User ç®¡ç†
  - Redis å†å²è®°å½•æŒä¹…åŒ–ï¼ˆå¯é…ç½®è¿‡æœŸæ—¶é—´ï¼‰
  - è‡ªåŠ¨å†å²è®°å½•ç®¡ç†
  - è‡ªåŠ¨ Redis åŒæ­¥
  
- âœ… **Agent é›†æˆ**
  - ç»Ÿä¸€çš„ `chat()` æ–¹æ³•ï¼Œæ”¯æŒæ™®é€šå¯¹è¯å’Œ Agent å¯¹è¯
  - é€šè¿‡ `use_agent=True` å¯ç”¨ ReAct Agent
  - è‡ªåŠ¨åˆ›å»º ReAct Agent
  - å¯æ§å†å²ç²’åº¦ï¼ˆ`save_only_answer`ï¼‰
    - `True`: åªä¿å­˜é—®ç­”ï¼ˆæ¨èï¼Œç®€æ´ï¼‰
    - `False`: ä¿å­˜å®Œæ•´æ€è€ƒè¿‡ç¨‹ï¼ˆè°ƒè¯•ç”¨ï¼‰
  - è‡ªåŠ¨æ¸…ç†ä¸­é—´æ¨ç†æ­¥éª¤
  
- âœ… **ç®€åŒ– API**
  ```python
  # âœ… æ™®é€šå¯¹è¯
  for chunk in chat_service.chat("ä½ å¥½"):
      print(chunk, end="")
  
  # âœ… Agent å¯¹è¯ï¼ˆ1 è¡Œï¼Œå…¨è‡ªåŠ¨ï¼‰
  answer = chat_service.chat(
      user_message="ä½ çš„é—®é¢˜",
      use_agent=True,
      agent_tools={"knowledge_search": knowledge_search},
      save_only_answer=True  # åªä¿å­˜é—®ç­”
  )
  ```

#### 2.3 ReAct Agentï¼ˆ`internal/agent/react_agent.py`ï¼‰ğŸ†•
- âœ… **çœŸæ­£çš„ ReAct æ¡†æ¶**
  - Thought â†’ Action â†’ Observation å¾ªç¯
  - çœŸå®å·¥å…·è°ƒç”¨ï¼ˆéä¼ªé€ ï¼‰
  - é˜²æ­¢å¾ªç¯å’Œé‡å¤ Action
  - å¼ºåˆ¶ä½¿ç”¨ Observation å†…å®¹ï¼ˆç¦æ­¢ç¼–é€ ï¼‰
  
- âœ… **æ™ºèƒ½æ§åˆ¶**
  - è‡ªåŠ¨æ£€æµ‹ LLM ç”Ÿæˆ Observation å¹¶æˆªæ–­
  - æ£€æµ‹é‡å¤ Action å¹¶å¼ºåˆ¶ç»™å‡º Answer
  - æœ€å¤š 5 è½®æ¨ç†ï¼ˆå¯é…ç½®ï¼‰
  - è¯¦ç»†çš„è°ƒè¯•è¾“å‡º

#### 2.4 Redis ç¼“å­˜æœåŠ¡ï¼ˆ`internal/db/redis.py`ï¼‰ğŸ†•
- âœ… **å•ä¾‹è¿æ¥ç®¡ç†**
  - è‡ªåŠ¨è¿æ¥å’Œé‡è¿
  - è¿æ¥æ± æ”¯æŒ
  
- âœ… **å®Œæ•´çš„ CRUD æ“ä½œ**
  - åŸºç¡€æ“ä½œï¼š`get`, `set`, `delete`, `exists`
  - è¿‡æœŸç®¡ç†ï¼š`expire`, `ttl`
  - Hash æ“ä½œï¼š`hset`, `hget`, `hgetall`
  - List æ“ä½œï¼š`lpush`, `rpush`, `lpop`, `rpop`, `lrange`
  - Set æ“ä½œï¼š`sadd`, `srem`, `smembers`, `scard`
  - Sorted Set æ“ä½œï¼š`zadd`, `zrange`, `zrem`
  - Pub/Subï¼š`publish`, `subscribe`

#### 2.5 Session æ¨¡å‹ï¼ˆ`internal/model/session.py`ï¼‰ğŸ†•
- âœ… **ä¼šè¯ç®¡ç†**
  - `SessionModel`: ä¼šè¯æ¨¡å‹ï¼ˆuuid, user_id, create_at, update_atï¼‰
  - `MessageModel`: æ–°å¢ `session_id` å­—æ®µï¼Œå…³è”ä¼šè¯
  - æ”¯æŒå¤šä¼šè¯ç®¡ç†

#### 2.6 Prompt ç®¡ç†ï¼ˆ`pkg/agent_prompt/`ï¼‰
- âœ… **å¤šåœºæ™¯ Prompt æ¨¡æ¿**
  - `DEFAULT_PROMPT`: é€šç”¨å¯¹è¯
  - `RAG_PROMPT`: åŸºäºçŸ¥è¯†åº“çš„é—®ç­”
  - `AGENT_RAG_PROMPT`: ReAct Agent ä¸“ç”¨ Prompt ğŸ†•
  - `CODE_PROMPT`: ä»£ç ç”Ÿæˆä¸è§£é‡Š
  - `DOCUMENT_PROMPT`: æ–‡æ¡£åˆ†æ
  - `SUMMARY_PROMPT`: èŠå¤©å†å²æ€»ç»“
  
- âœ… **å·¥å…·å®šä¹‰**ï¼ˆ`agent_tool.py`ï¼‰
  - `knowledge_search`: çŸ¥è¯†åº“æœç´¢ï¼ˆå·²å®ç°ï¼‰
  - IDE å¯ç‚¹å‡»è·³è½¬

#### 2.7 Embedding æœåŠ¡ï¼ˆ`internal/embedding/embedding_service.py`ï¼‰
- âœ… **æ–‡æœ¬å‘é‡åŒ–**
  - åŸºäº `sentence-transformers` 
  - æ”¯æŒæ–‡æ¡£æ‰¹é‡ç¼–ç ï¼ˆ`encode_documents`ï¼‰
  - æ”¯æŒæŸ¥è¯¢ç¼–ç ï¼ˆ`encode_query`ï¼Œå¸¦å½’ä¸€åŒ–ï¼‰
  - å•ä¾‹æ¨¡å¼ï¼Œé¿å…é‡å¤åŠ è½½
  - æ™ºèƒ½è®¾å¤‡é€‰æ‹©ï¼ˆCPU/CUDA/MPSï¼‰
  - HuggingFace ç¦»çº¿æ¨¡å¼æ”¯æŒ ğŸ†•

#### 2.8 Reranker æœåŠ¡ï¼ˆ`internal/reranker/reranker_service.py`ï¼‰
- âœ… **æ£€ç´¢ç»“æœé‡æ’åº**
  - åŸºäº `FlagEmbedding` çš„ BGE Reranker
  - è¯­ä¹‰ç›¸å…³æ€§äºŒæ¬¡è¯„åˆ†
  - æ”¯æŒè‡ªå®šä¹‰åˆ†æ•°é˜ˆå€¼ï¼ˆé»˜è®¤ -100.0ï¼‰
  - Logits è¾“å‡ºï¼ˆ-100 åˆ° +10ï¼Œåˆ†æ•°è¶Šé«˜è¶Šç›¸å…³ï¼‰
  - æ™ºèƒ½è®¾å¤‡é€‰æ‹©ï¼ˆCPU/CUDA/MPSï¼‰
  - HuggingFace ç¦»çº¿æ¨¡å¼æ”¯æŒ ğŸ†•

#### 2.9 æ–‡æ¡£å¤„ç†æœåŠ¡ï¼ˆ`internal/document/document_processor.py`ï¼‰
- âœ… **å¤šæ ¼å¼æ–‡æ¡£æ”¯æŒ**
  - `.txt`ã€`.pdf`ã€`.docx` æ ¼å¼
  - åŸºäº LangChain çš„æ–‡æ¡£åŠ è½½å™¨
  
- âœ… **æ–‡æ¡£å¤„ç†æµç¨‹**
  - `add_documents_to_mongodb`: ä¿å­˜åŸå§‹æ–‡æ¡£åˆ° MongoDBï¼Œç”Ÿæˆ UUID
  - `add_document_chunks_to_milvus`: æ–‡æ¡£åˆ†å‰²ã€å‘é‡åŒ–ã€å­˜å‚¨åˆ° Milvus
  - `add_documents`: å®Œæ•´çš„æ–‡æ¡£å…¥åº“æµç¨‹ç¼–æ’
  - å¯é…ç½® chunk_sizeï¼ˆé»˜è®¤500ï¼‰å’Œ chunk_overlapï¼ˆé»˜è®¤50ï¼‰
  - ä¾èµ–æ³¨å…¥è®¾è®¡ï¼Œé¿å…å¾ªç¯ä¾èµ–

#### 2.10 RAG æ£€ç´¢æœåŠ¡ï¼ˆ`internal/rag/rag_service.py`ï¼‰
- âœ… **æ™ºèƒ½æ£€ç´¢æµç¨‹**
  1. **å‘é‡æ£€ç´¢**: åœ¨ Milvus ä¸­æ£€ç´¢ Top-K å€™é€‰æ–‡æ¡£
  2. **Reranker é‡æ’åº**: è¯­ä¹‰ç›¸å…³æ€§äºŒæ¬¡è¯„åˆ†ï¼ˆå¯é€‰ï¼‰
  3. **æ™ºèƒ½å»é‡**: è¿‡æ»¤ç›¸ä¼¼åº¦ >= 98% çš„é‡å¤æ–‡æ¡£
  4. **ä¸Šä¸‹æ–‡ç”Ÿæˆ**: æ ¼å¼åŒ–ä¸º LLM å¯ç”¨çš„ä¸Šä¸‹æ–‡

- âœ… **æ£€ç´¢ç‰¹æ€§**
  - æ”¯æŒå…ƒæ•°æ®è¿‡æ»¤
  - å¯é…ç½®æ£€ç´¢æ•°é‡ï¼ˆé»˜è®¤5ä¸ªï¼‰
  - Reranker å¯å¼€å…³
  - è‡ªåŠ¨å»é‡ï¼Œä¿è¯ç»“æœå¤šæ ·æ€§

### 3. ğŸŒŸ **æµå¼ AI å¯¹è¯ç³»ç»Ÿ**ï¼ˆçœŸæ­£çš„å®æ—¶æµå¼ï¼‰âœ… ğŸ†•

#### 3.1 æ ¸å¿ƒç‰¹æ€§
- âœ… **Token-by-Token æµå¼è¾“å‡º**
  - LLM ç”Ÿæˆä¸€ä¸ª tokenï¼Œå®¢æˆ·ç«¯ç«‹å³æ”¶åˆ°
  - ä¸æ˜¯å‡æµå¼ï¼ˆåˆ†å—è¾“å‡ºå®Œæ•´ç­”æ¡ˆï¼‰
  - çœŸæ­£çš„å®æ—¶ä½“éªŒ
  
- âœ… **Agent æ¨ç†è¿‡ç¨‹å¯è§†åŒ–**
  - `show_thinking=true`: æ˜¾ç¤ºå®Œæ•´æ¨ç†è¿‡ç¨‹
  - `show_thinking=false`: åªæ˜¾ç¤ºæœ€ç»ˆç­”æ¡ˆ
  - å®æ—¶å±•ç¤ºï¼šThought â†’ Action â†’ Observation â†’ Answer

- âœ… **æŠ€æœ¯å®ç°**ï¼šå›è°ƒæœºåˆ¶ + å¼‚æ­¥é˜Ÿåˆ—
  ```python
  # Agent ç”Ÿæˆ token æ—¶è°ƒç”¨å›è°ƒ
  callback("llm_chunk", token)
      â†“
  # æ”¾å…¥é˜Ÿåˆ—
  event_queue.put((event_type, content))
      â†“
  # Service å¼‚æ­¥è¯»å–é˜Ÿåˆ—
  async for event in queue:
      yield {"event": "...", "data": {...}}
      â†“
  # Controller æ ¼å¼åŒ–ä¸º SSE
  yield f"event: answer_chunk\ndata: {json}\n\n"
      â†“
  # å®¢æˆ·ç«¯å®æ—¶æ¥æ”¶
  response.iter_lines()
  ```

#### 3.2 SSEï¼ˆServer-Sent Eventsï¼‰æ”¯æŒ
- âœ… **æ ‡å‡† SSE æ ¼å¼**
  - `Content-Type: text/event-stream`
  - å•å‘æ¨é€ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰
  - è‡ªåŠ¨é‡è¿æœºåˆ¶
  
- âœ… **äº‹ä»¶ç±»å‹**
  - `session_created`: ä¼šè¯åˆ›å»º
  - `user_message_saved`: ç”¨æˆ·æ¶ˆæ¯å·²ä¿å­˜
  - `thought`: Agent æ€è€ƒè¿‡ç¨‹
  - `action`: Agent æ‰§è¡ŒåŠ¨ä½œ
  - `observation`: å·¥å…·æ‰§è¡Œç»“æœ
  - `answer_chunk`: ç­”æ¡ˆç‰‡æ®µï¼ˆå®æ—¶è¾“å‡ºï¼‰
  - `ai_message_saved`: AI å›å¤å·²ä¿å­˜
  - `done`: å®Œæˆ
  - `error`: é”™è¯¯

#### 3.3 ä½¿ç”¨ç¤ºä¾‹
```python
# Python å®¢æˆ·ç«¯
import requests

response = requests.post(
    "http://localhost:8000/messages",
    json={
        "content": "ä»€ä¹ˆæ˜¯ RAG æŠ€æœ¯ï¼Ÿ",
        "user_id": "user_001",
        "show_thinking": True  # æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
    },
    stream=True
)

for line in response.iter_lines():
    if line:
        line_str = line.decode('utf-8')
        if line_str.startswith('event: '):
            event_type = line_str.replace('event: ', '').strip()
        elif line_str.startswith('data: '):
            event_data = json.loads(line_str.replace('data: ', ''))
            
            if event_type == 'thought':
                print(f"ğŸ’­ {event_data['content']}")
            elif event_type == 'action':
                print(f"ğŸ”§ {event_data['content']}")
            elif event_type == 'answer_chunk':
                print(event_data['content'], end='', flush=True)
```

```javascript
// JavaScript å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰
const eventSource = new EventSource('/messages?...');

eventSource.addEventListener('thought', (e) => {
    const data = JSON.parse(e.data);
    console.log('ğŸ’­ æ€è€ƒ:', data.content);
});

eventSource.addEventListener('answer_chunk', (e) => {
    const data = JSON.parse(e.data);
    document.getElementById('answer').innerHTML += data.content;
});

eventSource.addEventListener('done', (e) => {
    eventSource.close();
});
```

### 4. æµ‹è¯•ä¸æ¼”ç¤º

- âœ… **å®Œæ•´æµ‹è¯•å¥—ä»¶**
  - `test/test_mongodb.py`: MongoDB CRUD æµ‹è¯•
  - `test/test_milvus.py`: Milvus è¿æ¥å’Œæ£€ç´¢æµ‹è¯•
  - `test/test_redis.py`: Redis æ“ä½œæµ‹è¯• ğŸ†•
  - `test/test_rag.py`: RAG å®Œæ•´æµç¨‹æµ‹è¯•ï¼ˆå¯¹æ¯” Reranker æ•ˆæœï¼‰
  - `test/test_summary_mechanism.py`: å»¶è¿Ÿæ€»ç»“æœºåˆ¶æµ‹è¯• ğŸ†•
  - `test/test_chat_service.py`: ChatService å®Œæ•´æµ‹è¯• ğŸ†•
  - `test/test_full_rag_qa.py`: **å®Œæ•´çš„ RAG QA æ¼”ç¤ºï¼ˆChatService + Agent æ¶æ„ï¼‰** ğŸ†•
  - `test/test_user_api.py`: ç”¨æˆ·ç®¡ç† API æµ‹è¯• ğŸ†•
  - `test/test_document_api.py`: æ–‡æ¡£ç®¡ç† API æµ‹è¯• ğŸ†•
  - `test/test_session_api.py`: ä¼šè¯ç®¡ç† API æµ‹è¯• ğŸ†•
  - `test/test_message_api.py`: **æµå¼æ¶ˆæ¯ API æµ‹è¯•**ï¼ˆæ”¯æŒæ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºï¼‰ğŸ†• ğŸŒŸ

- âœ… **äº¤äº’å¼ RAG QA Demo**ï¼ˆ`test/test_full_rag_qa.py`ï¼‰
  - **ChatService æ¶æ„**: Session ç®¡ç† + Redis æŒä¹…åŒ–
  - **ReAct Agent**: çœŸå®å·¥å…·è°ƒç”¨ï¼Œå®Œæ•´æ¨ç†è¿‡ç¨‹
  - **æ™ºèƒ½æ£€ç´¢**: å‘é‡åŒ¹é… + Reranker + å»é‡
  - **å†å²ç®¡ç†**: å¯é€‰ä¿å­˜å®Œæ•´æ€è€ƒè¿‡ç¨‹æˆ–åªä¿å­˜é—®ç­”
  - **äº¤äº’å‘½ä»¤**: `history`ï¼ˆæŸ¥çœ‹å†å²ï¼‰ã€`clear`ï¼ˆæ¸…ç©ºï¼‰ã€`exit`ï¼ˆé€€å‡ºï¼‰
  - çœŸå®æ–‡æ¡£å¤„ç†ï¼ˆ.docxï¼‰
  - MongoDB + Milvus åŒé‡å­˜å‚¨
  - å®æ—¶å‘é‡æ£€ç´¢
  - æµå¼ LLM å¯¹è¯

- âœ… **æµå¼ AI å¯¹è¯æµ‹è¯•**ï¼ˆ`test/test_message_api.py`ï¼‰ğŸ†• ğŸŒŸ
  - **3ç§æµ‹è¯•æ¨¡å¼**ï¼š
    1. è‡ªåŠ¨æµ‹è¯•ï¼ˆæµå¼ï¼Œéšè—æ€è€ƒè¿‡ç¨‹ï¼‰
    2. äº¤äº’å¼èŠå¤©ï¼ˆæµå¼ï¼Œéšè—æ€è€ƒè¿‡ç¨‹ï¼‰
    3. äº¤äº’å¼èŠå¤©ï¼ˆæµå¼ï¼Œæ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹ï¼‰â­
  - **å®æ—¶æ¨ç†å±•ç¤º**ï¼šçœ‹åˆ° Agent çš„å®Œæ•´æ€è€ƒè¿‡ç¨‹
  - **çœŸæ­£çš„æµå¼**ï¼šLLM ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ï¼Œç«‹å³æ˜¾ç¤º
  - **Agent + RAG é›†æˆ**ï¼šä¸ `test_full_rag_qa.py` å®Œå…¨ä¸€è‡´

### 5. å·¥å…·ä¸æœåŠ¡

#### 5.1 å¯†ç åŠ å¯†ï¼ˆ`pkg/utils/password_utils.py`ï¼‰âœ… ğŸ†•
- âœ… **bcrypt å¯†ç å“ˆå¸Œ**
  - `hash_password()`: å¯†ç åŠ å¯†
  - `verify_password()`: å¯†ç éªŒè¯
  - å®‰å…¨çš„ç›å€¼ç”Ÿæˆ

#### 5.2 JWT è®¤è¯ï¼ˆ`pkg/utils/jwt_utils.py`ï¼‰âœ… ğŸ†•
- âœ… **Token ç®¡ç†**
  - `create_token()`: åˆ›å»º JWT token
  - `verify_token()`: éªŒè¯å’Œè§£æ token
  - è¿‡æœŸæ—¶é—´æ§åˆ¶
  - SECRET_KEY ä»ç¯å¢ƒå˜é‡åŠ è½½

#### 5.3 é‚®ä»¶æœåŠ¡ï¼ˆ`pkg/utils/email_service.py`ï¼‰âœ… ğŸ†•
- âœ… **éªŒè¯ç å‘é€**
  - `send_verification_code()`: å‘é€é‚®ç®±éªŒè¯ç 
  - `verify_code()`: éªŒè¯éªŒè¯ç 
  - Redis å­˜å‚¨ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
  - SMTP TLS æ”¯æŒ
  - é‚®ä»¶æ¨¡æ¿

#### 5.4 æ–‡æ¡£å¤„ç†å·¥å…·ï¼ˆ`pkg/utils/document_utils.py`ï¼‰âœ… ğŸ†•
- âœ… **æ–‡æ¡£åŠ è½½**
  - è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç±»å‹
  - æ”¯æŒ PDFã€DOCXã€TXTã€Markdown
  - `load_documents()`: æ‰¹é‡åŠ è½½
  
- âœ… **æ–‡æ¡£åˆ†å‰²**
  - `split_documents()`: æ™ºèƒ½åˆ†å—
  - å¯é…ç½® chunk_size å’Œ overlap
  - ä¿ç•™æ–‡æ¡£å…ƒæ•°æ®

- âœ… **æ–‡æœ¬æ¸…ç†**
  - `clean_text()`: å»é™¤ç‰¹æ®Šå­—ç¬¦
  - ç»Ÿä¸€ç©ºç™½ç¬¦å¤„ç†

#### 5.5 æ—¥å¿—ç³»ç»Ÿï¼ˆ`log/logger.py`ï¼‰âœ… ğŸ†•
- âœ… **Loguru é›†æˆ**
  - JSON æ ¼å¼è¾“å‡ºï¼ˆNDJSONï¼‰
  - è‡ªåŠ¨è®°å½•è°ƒç”¨ä½ç½®
  - Stack trace æ”¯æŒ
  - åŒè¾“å‡ºï¼ˆæ§åˆ¶å° + æ–‡ä»¶ï¼‰
  - è‡ªåŠ¨æ—¥å¿—è½®è½¬ï¼ˆæŒ‰æ—¥æœŸï¼‰
  - ç»“æ„åŒ–å­—æ®µï¼ˆDebug, Info, Warn, Error, Fatalï¼‰
  - æ—¥å¿—ç›®å½•ï¼š`json_log/YY_MM_DD_log/*.json`

### 6. FastAPI Web æœåŠ¡ âœ… ğŸ†•

#### 6.1 åº”ç”¨å…¥å£ï¼ˆ`main.py`ï¼‰
- âœ… **æœåŠ¡å™¨å¯åŠ¨**
  - MongoDBã€Redisã€Milvus åˆå§‹åŒ–
  - æ–‡æ¡£å¤„ç†å™¨å¯åŠ¨
  - FastAPI åº”ç”¨é…ç½®
  - uvicorn æœåŠ¡å™¨

#### 6.2 è·¯ç”±ç®¡ç†ï¼ˆ`internal/http_server/routes.py`ï¼‰
- âœ… **ç»Ÿä¸€è·¯ç”±æ³¨å†Œ**
  - ç”¨æˆ·ç®¡ç†è·¯ç”±
  - æ–‡æ¡£ç®¡ç†è·¯ç”±
  - ä¼šè¯ç®¡ç†è·¯ç”±
  - æ¶ˆæ¯ç®¡ç†è·¯ç”±
  - è‡ªåŠ¨æ‰“å°æ‰€æœ‰è·¯ç”±

#### 6.3 å“åº”æ§åˆ¶å™¨ï¼ˆ`api/v1/response_controller.py`ï¼‰
- âœ… **ç»Ÿä¸€å“åº”æ ¼å¼**
  - `json_response()`: æ ‡å‡† JSON å“åº”
  - è‡ªåŠ¨é”™è¯¯å¤„ç†
  - çŠ¶æ€ç æ˜ å°„

#### 6.4 DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰
- âœ… **Request DTOs**ï¼ˆ`internal/dto/request/`ï¼‰
  - `user_request.py`: ç”¨æˆ·ç›¸å…³è¯·æ±‚
  - `message_request.py`: æ¶ˆæ¯ç›¸å…³è¯·æ±‚ï¼ˆå« `show_thinking`ï¼‰
  - `session_request.py`: ä¼šè¯ç›¸å…³è¯·æ±‚
  - Pydantic éªŒè¯

- âœ… **Response DTOs**ï¼ˆ`internal/dto/respond/`ï¼‰
  - `user_response.py`: ç”¨æˆ·ä¿¡æ¯å“åº”
  - `document_response.py`: æ–‡æ¡£å“åº”
  - `session_response.py`: ä¼šè¯å“åº”
  - `message_response.py`: æ¶ˆæ¯å“åº”
  - è‡ªåŠ¨åºåˆ—åŒ–

### 7. å¼€å‘ç¯å¢ƒä¸é…ç½®

- âœ… **å®Œæ•´çš„ä¾èµ–ç®¡ç†**
  - `requirements.txt`: æ‰€æœ‰ Python ä¾èµ–
  - `.gitignore`: Git å¿½ç•¥è§„åˆ™
  - `env_template.txt`: ç¯å¢ƒå˜é‡æ¨¡æ¿
  - `bcrypt`, `PyJWT`, `email-validator` ç­‰æ–°å¢ä¾èµ–

- âœ… **ç¯å¢ƒé…ç½®**ï¼ˆ`pkg/constants/constants.py`ï¼‰
  - **ç»Ÿä¸€é…ç½®ç®¡ç†**: æ‰€æœ‰é…ç½®ä» `.env` åŠ è½½
  - **æ™ºèƒ½è®¾å¤‡é€‰æ‹©**: è‡ªåŠ¨æ£€æµ‹ CUDA/MPS/CPU
  - **HuggingFace ç¦»çº¿æ¨¡å¼**: é¿å…è”ç½‘æ£€æŸ¥ ğŸ†•
    - `TRANSFORMERS_OFFLINE=1`
    - `HF_HUB_OFFLINE=1`
  - **Redis é…ç½®**: Hostã€Portã€DBã€Password ğŸ†•
  - **é‚®ä»¶æœåŠ¡é…ç½®**: SMTP æœåŠ¡å™¨ã€ç«¯å£ã€è®¤è¯ ğŸ†•
  - **JWT é…ç½®**: SECRET_KEYã€è¿‡æœŸæ—¶é—´ ğŸ†•
  - **å¯¼å…¥é¡ºåºä¼˜åŒ–**: ç¡®ä¿ç¯å¢ƒå˜é‡åœ¨åº“å¯¼å…¥å‰è®¾ç½® ğŸ†•

- âœ… **Docker éƒ¨ç½²**
  - `milvus/docker-compose.yml`: Milvus ç”Ÿæ€ä¸€é”®éƒ¨ç½²
    - Milvus å‘é‡æ•°æ®åº“
    - MinIO å¯¹è±¡å­˜å‚¨
    - Attu å¯è§†åŒ–ç®¡ç†ç•Œé¢ï¼ˆhttp://localhost:8000ï¼‰
  - `mongodb/docker-compose.yml`: MongoDB éƒ¨ç½² ğŸ†•
  - Redis éƒ¨ç½²ï¼ˆæ¨è Dockerï¼‰
  - Kafka éƒ¨ç½²ï¼ˆ`Kafka/docker-compose.yml`ï¼‰ğŸ†•

---

## ğŸ¯ æ¶æ„äº®ç‚¹ ğŸ†•

### 1. ğŸŒŸ çœŸæ­£çš„æµå¼ AI å¯¹è¯å®ç°ï¼ˆæ ¸å¿ƒåˆ›æ–°ï¼‰

#### 1.1 æŠ€æœ¯æŒ‘æˆ˜
ä¼ ç»Ÿçš„æµå¼å®ç°å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- âŒ **å‡æµå¼**ï¼šå…ˆç”Ÿæˆå®Œæ•´ç­”æ¡ˆï¼Œå†åˆ†å—è¾“å‡º
- âŒ **æ— æ³•å±•ç¤ºæ€è€ƒè¿‡ç¨‹**ï¼šç”¨æˆ·çœ‹ä¸åˆ° Agent çš„æ¨ç†è¿‡ç¨‹
- âŒ **å¼‚æ­¥å›°å¢ƒ**ï¼šAgent æ˜¯åŒæ­¥ä»£ç ï¼ŒAPI æ˜¯å¼‚æ­¥ä»£ç 

#### 1.2 è§£å†³æ–¹æ¡ˆï¼šå›è°ƒ + é˜Ÿåˆ— + å¼‚æ­¥ç”Ÿæˆå™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 1 å±‚ï¼šLLM æµå¼ç”Ÿæˆï¼ˆåŒæ­¥ï¼‰                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  LLMService.chat(stream=True)                     â”‚  â”‚
â”‚  â”‚    â†’ yield "RAG"                                  â”‚  â”‚
â”‚  â”‚    â†’ yield " æ˜¯"                                  â”‚  â”‚
â”‚  â”‚    â†’ yield " æ£€ç´¢"                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ token
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 2 å±‚ï¼šReActAgent å›è°ƒï¼ˆåŒæ­¥ï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ReActAgent.__init__(callback=callback_fn)        â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  def run(question, stream=True):                  â”‚  â”‚
â”‚  â”‚      for chunk in llm.chat(..., stream=True):    â”‚  â”‚
â”‚  â”‚          if self.callback:                        â”‚  â”‚
â”‚  â”‚              self.callback("llm_chunk", chunk) â”â”â”â”‚â”â”â”â”â”
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                                                                â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ callback
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 3 å±‚ï¼šé˜Ÿåˆ—ä¼ é€’ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  import queue                                     â”‚  â”‚
â”‚  â”‚  event_queue = queue.Queue()                      â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  def callback(event_type, content):               â”‚  â”‚
â”‚  â”‚      event_queue.put((event_type, content)) â”â”â”â”â”â”â”‚â”â”â”â”â”
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                                               â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ put
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 4 å±‚ï¼šå¼‚æ­¥åå°ä»»åŠ¡ï¼ˆasyncioï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  # åœ¨åå°çº¿ç¨‹è¿è¡ŒåŒæ­¥ Agent                         â”‚  â”‚
â”‚  â”‚  async def run_agent():                           â”‚  â”‚
â”‚  â”‚      return await asyncio.to_thread(              â”‚  â”‚
â”‚  â”‚          lambda: agent.run(message, stream=True)  â”‚  â”‚
â”‚  â”‚      )                                            â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  agent_task = asyncio.create_task(run_agent()) â”â”â”‚â”â”â”â”â”
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ åå°è¿è¡Œ
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 5 å±‚ï¼šå¼‚æ­¥ç”Ÿæˆå™¨ï¼ˆService å±‚ï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  async def _generate_ai_reply_stream(...):        â”‚  â”‚
â”‚  â”‚      while not agent_task.done() or               â”‚  â”‚
â”‚  â”‚            not event_queue.empty():               â”‚  â”‚
â”‚  â”‚          try:                                     â”‚  â”‚
â”‚  â”‚              event_type, content =                â”‚  â”‚
â”‚  â”‚                  event_queue.get_nowait()  â—€â”â”â”â”â”â”â”‚â”â”â” å®æ—¶è¯»å–
â”‚  â”‚              yield {                              â”‚  â”‚
â”‚  â”‚                  "event": "answer_chunk",         â”‚  â”‚
â”‚  â”‚                  "data": {"content": content}     â”‚  â”‚
â”‚  â”‚              } â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚â”â”â”â”â”
â”‚  â”‚          except queue.Empty:                      â”‚  â”‚  â”‚
â”‚  â”‚              await asyncio.sleep(0.01)            â”‚  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ yield
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 6 å±‚ï¼šSSE æ ¼å¼åŒ–ï¼ˆController å±‚ï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  async def event_generator():                     â”‚  â”‚
â”‚  â”‚      async for event_dict in                      â”‚  â”‚
â”‚  â”‚          message_service.send_message_stream(...):â”‚  â”‚
â”‚  â”‚          event_type = event_dict["event"]         â”‚  â”‚
â”‚  â”‚          event_data = event_dict["data"]          â”‚  â”‚
â”‚  â”‚          yield f"event: {event_type}\n"           â”‚  â”‚
â”‚  â”‚          yield f"data: {json.dumps(event_data)}\n"â”‚  â”‚
â”‚  â”‚          yield "\n"  # SSE åˆ†éš”ç¬¦ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚â”â”â”â”â”
â”‚  â”‚                                                    â”‚  â”‚  â”‚
â”‚  â”‚  return StreamingResponse(                        â”‚  â”‚  â”‚
â”‚  â”‚      event_generator(),                           â”‚  â”‚  â”‚
â”‚  â”‚      media_type="text/event-stream"               â”‚  â”‚  â”‚
â”‚  â”‚  ) â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚â”â”â”â”â”¤
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP Stream
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 7 å±‚ï¼šå®¢æˆ·ç«¯æ¥æ”¶ï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  response = requests.post(..., stream=True)       â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  for line in response.iter_lines():               â”‚  â”‚
â”‚  â”‚      if line.startswith('event: '):               â”‚  â”‚
â”‚  â”‚          event_type = line.replace('event: ', '') â”‚  â”‚
â”‚  â”‚      elif line.startswith('data: '):              â”‚  â”‚
â”‚  â”‚          data = json.loads(line.replace(...))     â”‚  â”‚
â”‚  â”‚          if event_type == 'answer_chunk':         â”‚  â”‚
â”‚  â”‚              print(data['content'], end='') â”â”â”â”â”â”â”‚â”â”â” å®æ—¶æ‰“å°ï¼
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.3 å…³é”®æŠ€æœ¯ç‚¹

1. **å›è°ƒæœºåˆ¶ï¼ˆCallbackï¼‰**
   - `ReActAgent` æ¥æ”¶ `callback` å‡½æ•°
   - LLM æ¯ç”Ÿæˆä¸€ä¸ª tokenï¼Œç«‹å³è°ƒç”¨ `callback("llm_chunk", token)`
   - å®ç°ï¼š`internal/agent/react_agent.py`

2. **çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼ˆqueue.Queueï¼‰**
   - åŒæ­¥ä»£ç ï¼ˆAgentï¼‰å‘é˜Ÿåˆ—å†™å…¥
   - å¼‚æ­¥ä»£ç ï¼ˆServiceï¼‰ä»é˜Ÿåˆ—è¯»å–
   - è·¨çº¿ç¨‹é€šä¿¡çš„æ¡¥æ¢

3. **åå°ä»»åŠ¡ï¼ˆasyncio.to_threadï¼‰**
   - å°†åŒæ­¥çš„ `agent.run()` æ”¾åˆ°åå°çº¿ç¨‹
   - ä¸é˜»å¡å¼‚æ­¥äº‹ä»¶å¾ªç¯
   - å®ç°ï¼š`asyncio.create_task(asyncio.to_thread(agent.run))`

4. **å¼‚æ­¥ç”Ÿæˆå™¨ï¼ˆAsyncGeneratorï¼‰**
   - ä½¿ç”¨ `yield` å®æ—¶äº§å‡ºäº‹ä»¶
   - ä½¿ç”¨ `queue.get_nowait()` éé˜»å¡è¯»å–
   - å®ç°ï¼š`async def _generate_ai_reply_stream() -> AsyncGenerator[Dict, None]`

5. **SSEï¼ˆServer-Sent Eventsï¼‰**
   - æ ‡å‡†çš„ HTTP æµå¼åè®®
   - æ ¼å¼ï¼š`event: <type>\ndata: <json>\n\n`
   - `Content-Type: text/event-stream`

#### 1.4 æ ¸å¿ƒä»£ç ç‰‡æ®µ

```python
# internal/agent/react_agent.py
class ReActAgent:
    def __init__(self, llm_service, tools, callback: Optional[Callable] = None):
        self.callback = callback
    
    def run(self, question: str, stream: bool = False) -> str:
        for chunk in self.llm_service.chat(stream=True):
            if self.callback:
                self.callback("llm_chunk", chunk)  # ğŸ”¥ å…³é”®ï¼šæ¯ä¸ª token éƒ½å›è°ƒ

# internal/service/orm/message_sever.py
async def _generate_ai_reply_stream(self, ...):
    event_queue = queue.Queue()  # ğŸ”¥ çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—
    
    def callback(event_type, content):
        event_queue.put((event_type, content))  # ğŸ”¥ å†™å…¥é˜Ÿåˆ—
    
    agent = ReActAgent(..., callback=callback)
    
    # ğŸ”¥ åå°è¿è¡ŒåŒæ­¥ Agent
    agent_task = asyncio.create_task(
        asyncio.to_thread(lambda: agent.run(message, stream=True))
    )
    
    # ğŸ”¥ å®æ—¶è¯»å–é˜Ÿåˆ—å¹¶ yield
    while not agent_task.done() or not event_queue.empty():
        try:
            event_type, content = event_queue.get_nowait()
            yield {"event": "answer_chunk", "data": {"content": content}}
        except queue.Empty:
            await asyncio.sleep(0.01)
```

#### 1.5 ä¼˜åŠ¿
- âœ… **çœŸæ­£çš„å®æ—¶**ï¼šLLM ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ï¼Œå®¢æˆ·ç«¯ç«‹å³æ”¶åˆ°
- âœ… **æ€è€ƒè¿‡ç¨‹å¯è§†åŒ–**ï¼š`show_thinking=true` å¯ä»¥çœ‹åˆ° Agent æ¨ç†
- âœ… **æ€§èƒ½ä¼˜å¼‚**ï¼šéé˜»å¡ï¼Œæ”¯æŒå¹¶å‘
- âœ… **æ˜“äºæ‰©å±•**ï¼šåªéœ€æ·»åŠ æ–°çš„ `callback` äº‹ä»¶ç±»å‹

### 2. åˆ†å±‚æ¶æ„ - å•ä¸€èŒè´£åŸåˆ™
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ChatServiceï¼ˆä¼šè¯å±‚ï¼‰                 â”‚
â”‚  - Session ç®¡ç†                                  â”‚
â”‚  - Redis æŒä¹…åŒ–                                  â”‚
â”‚  - Agent ç¼–æ’                                    â”‚
â”‚  - å†å²è®°å½•ç²’åº¦æ§åˆ¶                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLMService  â”‚  â”‚ ReActAgent  â”‚
â”‚ - æ¨¡å‹è°ƒç”¨   â”‚  â”‚ - å·¥å…·è°ƒç”¨   â”‚
â”‚ - Prompt    â”‚  â”‚ - æ¨ç†å¾ªç¯   â”‚
â”‚ - å†å²ç®¡ç†   â”‚  â”‚ - å¼ºåˆ¶çº¦æŸ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**ï¼š
- âœ… å„å±‚èŒè´£æ¸…æ™°ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- âœ… ChatService ç»Ÿä¸€å…¥å£ï¼Œå±è”½åº•å±‚å¤æ‚æ€§
- âœ… LLMService ä¸“æ³¨å¯¹è¯ï¼ŒAgent ä¸“æ³¨å·¥å…·è°ƒç”¨
- âœ… Sessionã€Redisã€å†å²è®°å½•ç”± ChatService ç»Ÿä¸€ç®¡ç†

### 3. ç®€åŒ– API - é™ä½ä½¿ç”¨éš¾åº¦
```python
# âŒ æ—§æ–¹å¼ï¼ˆ7+ è¡Œï¼Œå®¹æ˜“å‡ºé”™ï¼‰
llm = LLMService(...)
agent = create_react_agent(llm, tools)
answer = agent.run(question)
llm.add_to_history("user", question)
llm.add_to_history("assistant", answer)
chat_service._save_history_to_redis()

# âœ… æ–°æ–¹å¼ï¼ˆç»Ÿä¸€çš„ chat æ–¹æ³•ï¼‰
# æ™®é€šå¯¹è¯
for chunk in chat_service.chat("ä½ å¥½"):
    print(chunk, end="")

# Agent å¯¹è¯ï¼ˆ1 è¡Œï¼Œå…¨è‡ªåŠ¨ï¼‰
answer = chat_service.chat(
    user_message="é—®é¢˜",
    use_agent=True,
    agent_tools={"knowledge_search": knowledge_search}
)
```

### 4. æ™ºèƒ½å†å²ç®¡ç†
- **å»¶è¿Ÿæ€»ç»“**ï¼šä¸é˜»å¡å½“å‰å¯¹è¯ï¼Œåœ¨ä¸‹æ¬¡å¯¹è¯å‰æ‰§è¡Œ
- **è‡ªåŠ¨åŒæ­¥**ï¼šå†å²è®°å½•è‡ªåŠ¨ä¿å­˜åˆ° Redis
- **å¯æ§ç²’åº¦**ï¼š`save_only_answer=True` åªä¿å­˜é—®ç­”ï¼Œè‡ªåŠ¨æ¸…ç†ä¸­é—´æ¨ç†
- **Session éš”ç¦»**ï¼šå¤šç”¨æˆ·ã€å¤šä¼šè¯äº’ä¸å¹²æ‰°

### 5. ç¯å¢ƒå˜é‡ä¼˜åŒ–
```python
# ğŸ”¥ å…³é”®ï¼šconstants.py å¿…é¡»æœ€å…ˆå¯¼å…¥
from pkg.constants.constants import RUNNING_MODE  # è®¾ç½®ç¯å¢ƒå˜é‡

from sentence_transformers import SentenceTransformer  # HuggingFace åº“
```

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨è®¾ç½® `TRANSFORMERS_OFFLINE` å’Œ `HF_HUB_OFFLINE`
- âœ… é¿å… HuggingFace åº“è”ç½‘æ£€æŸ¥
- âœ… æ™ºèƒ½è®¾å¤‡é€‰æ‹©ï¼ˆCUDA/MPS/CPUï¼‰
- âœ… ç»Ÿä¸€é…ç½®ç®¡ç†ï¼Œæ˜“äºéƒ¨ç½²

---

## ğŸš§ è®¡åˆ’ä¸­åŠŸèƒ½

### ç¬¬ä¸€é˜¶æ®µï¼šAPI å±‚å’Œå‰ç«¯ âœ…

#### 1. FastAPI RESTful APIï¼ˆ`api/v1/`ï¼‰âœ… ğŸ†•

##### 1.1 ç”¨æˆ·ç®¡ç† APIï¼ˆ`user_info_controller.py`ï¼‰âœ…
- âœ… `POST /users`: ç”¨æˆ·æ³¨å†Œï¼ˆé‚®ç®±éªŒè¯ç ï¼‰
- âœ… `POST /users/login`: ç”¨æˆ·ç™»å½•ï¼ˆæ˜µç§°+å¯†ç ï¼‰
- âœ… `POST /users/email-login`: é‚®ç®±éªŒè¯ç ç™»å½•
- âœ… `GET /users/{user_id}`: è·å–ç”¨æˆ·ä¿¡æ¯
- âœ… `PATCH /users/{user_id}`: æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- âœ… `GET /users`: è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
- âœ… `DELETE /users/{user_id_list}`: æ‰¹é‡åˆ é™¤ç”¨æˆ·
- âœ… `PATCH /users/set-admin`: è®¾ç½®ç®¡ç†å‘˜
- âœ… `POST /users/email-code`: å‘é€é‚®ç®±éªŒè¯ç 

##### 1.2 æ–‡æ¡£ç®¡ç† APIï¼ˆ`document_controller.py`ï¼‰âœ…
- âœ… `POST /documents`: é«˜çº§æ–‡æ¡£ä¸Šä¼ 
  - ä¿å­˜åˆ° MongoDB å’Œ Milvus
  - è‡ªåŠ¨å‘é‡åŒ–å’Œåˆ†å—
  - æ”¯æŒå…¨æ–‡æ£€ç´¢
- âœ… `GET /documents`: è·å–æ–‡æ¡£åˆ—è¡¨ï¼ˆåˆ†é¡µã€å…³é”®è¯æœç´¢ï¼‰
- âœ… `GET /documents/{document_id}`: è·å–æ–‡æ¡£è¯¦æƒ…
- âœ… `DELETE /documents/{document_id}`: åˆ é™¤æ–‡æ¡£

##### 1.3 ä¼šè¯ç®¡ç† APIï¼ˆ`session_controller.py`ï¼‰âœ…
- âœ… `GET /sessions`: è·å–ä¼šè¯åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
- âœ… `GET /sessions/{session_id}`: è·å–ä¼šè¯è¯¦æƒ…
- âœ… `PATCH /sessions/{session_id}`: æ›´æ–°ä¼šè¯ï¼ˆåç§°ã€æœ€åæ¶ˆæ¯ï¼‰

##### 1.4 æ¶ˆæ¯ç®¡ç† APIï¼ˆ`message_controller.py`ï¼‰âœ… ğŸŒŸ
- âœ… `POST /messages`: **æµå¼ AI å¯¹è¯**ï¼ˆSSEï¼‰
  - **çœŸæ­£çš„æµå¼è¾“å‡º**ï¼ˆToken-by-Tokenï¼‰
  - **Agent + RAG æ£€ç´¢**ï¼ˆè‡ªåŠ¨è°ƒç”¨çŸ¥è¯†åº“ï¼‰
  - **æ€è€ƒè¿‡ç¨‹å¯é€‰**ï¼ˆ`show_thinking` å‚æ•°ï¼‰
  - **è‡ªåŠ¨åˆ›å»ºä¼šè¯**ï¼ˆä¸æä¾› `session_id` æ—¶ï¼‰
  - **å®æ—¶æ¨ç†å±•ç¤º**ï¼ˆThought â†’ Action â†’ Observation â†’ Answerï¼‰
- âœ… `GET /messages/{session_id}`: è·å–ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆåˆ†é¡µï¼‰

#### 2. ç»Ÿä¸€å“åº”æ ¼å¼ âœ…
```python
# æ ‡å‡† JSON å“åº”
{
    "code": 200,        # 0: æˆåŠŸ, -1: å¤±è´¥, 200/400/500: HTTP çŠ¶æ€ç 
    "message": "æˆåŠŸ",
    "data": { ... }     # ä¸šåŠ¡æ•°æ®
}

# SSE æµå¼å“åº”ï¼ˆPOST /messagesï¼‰
event: session_created
data: {"session_id": "xxx", "session_name": "xxx"}

event: thought
data: {"content": "ç”¨æˆ·è¯¢é—® RAGï¼Œéœ€è¦æ£€ç´¢çŸ¥è¯†åº“"}

event: action
data: {"content": "knowledge_search(\"RAG\", 3)"}

event: observation
data: {"content": "æ‰¾åˆ°3æ¡ç›¸å…³æ–‡æ¡£..."}

event: answer_chunk
data: {"content": "RAG"}

event: done
data: {"session_id": "xxx"}
```

#### 2. å‰ç«¯ç•Œé¢
- â³ Web UIï¼ˆReact/Vueï¼‰
  - æ–‡æ¡£ä¸Šä¼ ç•Œé¢
  - å®æ—¶é—®ç­”ç•Œé¢ï¼ˆæµå¼æ˜¾ç¤ºï¼‰
  - èŠå¤©å†å²ç®¡ç†
  - æ–‡æ¡£ç®¡ç†ç•Œé¢

### ç¬¬äºŒé˜¶æ®µï¼šé«˜çº§åŠŸèƒ½

#### 1. æº¯æºç³»ç»Ÿ
- â³ **ç­”æ¡ˆæº¯æº**
  - åœ¨ç”Ÿæˆçš„ç­”æ¡ˆä¸­æ’å…¥è§’æ ‡ [1][2]
  - ç‚¹å‡»è§’æ ‡æ˜¾ç¤ºåŸå§‹æ–‡æ¡£ç‰‡æ®µ
  - é«˜äº®æ˜¾ç¤ºåŒ¹é…å†…å®¹
  - æ”¯æŒè·³è½¬åˆ°åŸå§‹æ–‡æ¡£

#### 2. ç¼“å­˜ä¸ä¼šè¯ç®¡ç†
- âœ… **Redis é›†æˆ**ï¼ˆ`internal/db/redis.py`ï¼‰ğŸ†•
  - å•ä¾‹è¿æ¥ç®¡ç†
  - å®Œæ•´çš„ CRUD æ“ä½œ
  - å¤šè½®å¯¹è¯å†å²å­˜å‚¨
  - ç”¨æˆ·ä¼šè¯ç®¡ç†ï¼ˆSession + Userï¼‰
  - è‡ªåŠ¨è¿‡æœŸç®¡ç†
  
- â³ **é«˜çº§ç¼“å­˜ç­–ç•¥**
  - çƒ­ç‚¹æ•°æ®ç¼“å­˜
  - æ£€ç´¢ç»“æœç¼“å­˜
  - ç¼“å­˜é¢„çƒ­

#### 3. å¼‚æ­¥å¤„ç†ä¼˜åŒ–
- â³ **Kafka æ¶ˆæ¯é˜Ÿåˆ—**ï¼ˆ`internal/Kafka/`ï¼‰
  - æ–‡æ¡£ä¸Šä¼ åå¼‚æ­¥è§¦å‘ Embedding
  - å¤§æ‰¹é‡æ–‡æ¡£å¤„ç†é˜Ÿåˆ—
  - ä»»åŠ¡çŠ¶æ€è¿½è¸ª
  - å¤±è´¥é‡è¯•æœºåˆ¶

### ç¬¬ä¸‰é˜¶æ®µï¼šä¼ä¸šçº§ç‰¹æ€§

#### 1. æ€§èƒ½ä¼˜åŒ–
- â³ **æ£€ç´¢æ€§èƒ½æå‡**
  - Milvus åˆ†åŒºå’Œåˆ†ç‰‡
  - å‘é‡ç´¢å¼•ä¼˜åŒ–ï¼ˆIVF_FLAT â†’ HNSWï¼‰
  - æ‰¹é‡æ£€ç´¢ä¼˜åŒ–
  - ç»“æœç¼“å­˜ç­–ç•¥

- â³ **å¹¶å‘å¤„ç†**
  - å¼‚æ­¥æ–‡æ¡£å¤„ç†
  - å¹¶å‘ Embedding
  - æµå¼ç»“æœè¿”å›

#### 2. å¤šæ¨¡å‹æ”¯æŒ
- â³ é›†æˆæ›´å¤š LLM æ¨¡å‹
  - é€šä¹‰åƒé—®ï¼ˆQwenï¼‰
  - ChatGPTï¼ˆGPT-4ï¼‰
  - æ–‡å¿ƒä¸€è¨€ï¼ˆERNIEï¼‰
  - Claude

#### 3. é«˜çº§ RAG æŠ€æœ¯
- â³ **æ··åˆæ£€ç´¢**
  - å‘é‡æ£€ç´¢ + å…³é”®è¯æ£€ç´¢ï¼ˆBM25ï¼‰
  - èåˆæ’åº

- â³ **æŸ¥è¯¢ä¼˜åŒ–**
  - æŸ¥è¯¢æ”¹å†™ï¼ˆQuery Rewriteï¼‰
  - æŸ¥è¯¢æ‰©å±•ï¼ˆQuery Expansionï¼‰
  - HyDEï¼ˆå‡è®¾æ€§æ–‡æ¡£ Embeddingï¼‰

- â³ **ä¸Šä¸‹æ–‡å‹ç¼©**
  - LLMLingua ä¸Šä¸‹æ–‡å‹ç¼©
  - åŠ¨æ€ chunk é€‰æ‹©

#### 4. ç›‘æ§ä¸æ—¥å¿—
- â³ **ç³»ç»Ÿç›‘æ§**
  - æ£€ç´¢æ€§èƒ½ç›‘æ§
  - Token æ¶ˆè€—ç»Ÿè®¡
  - API è°ƒç”¨ç»Ÿè®¡
  - é”™è¯¯æ—¥å¿—æ”¶é›†

#### 5. æƒé™ä¸å®‰å…¨
- â³ **ç”¨æˆ·æƒé™ç³»ç»Ÿ**
  - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
  - æ–‡æ¡£æƒé™ç®¡ç†
  - API é‰´æƒï¼ˆJWTï¼‰

### ç¬¬å››é˜¶æ®µï¼šéƒ¨ç½²ä¸äº¤ä»˜

- â³ **å®Œæ•´ Docker åŒ–**
  - æ‰€æœ‰æœåŠ¡çš„ Docker é•œåƒ
  - Docker Compose ä¸€é”®éƒ¨ç½²
  - Kubernetes ç¼–æ’æ”¯æŒ

- â³ **CI/CD æµç¨‹**
  - è‡ªåŠ¨åŒ–æµ‹è¯•
  - è‡ªåŠ¨åŒ–éƒ¨ç½²
  - ç‰ˆæœ¬ç®¡ç†

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯å±‚ï¼ˆè®¡åˆ’ä¸­ï¼‰                         â”‚
â”‚                    Web UI / Mobile App                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API å±‚ï¼ˆFastAPI - è®¡åˆ’ä¸­ï¼‰                 â”‚
â”‚          /chat  /search  /documents  /auth                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ ¸å¿ƒæœåŠ¡å±‚ âœ…                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ LLM Service â”‚  â”‚ RAG Service  â”‚  â”‚ Doc Processorâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Embedding  â”‚  â”‚   Reranker   â”‚  â”‚ Prompt Mgmt  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ¨¡å‹ç®¡ç†å±‚ âœ…                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           ç»Ÿä¸€æ¨¡å‹ç®¡ç†å™¨ï¼ˆModelManagerï¼‰                â”‚   â”‚
â”‚  â”‚  LLM Models | Embedding Models | Reranker Models    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®å­˜å‚¨å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ MongoDB  â”‚  â”‚  Milvus  â”‚  â”‚  Redis   â”‚  â”‚  Kafka   â”‚   â”‚
â”‚  â”‚    âœ…     â”‚  â”‚    âœ…     â”‚  â”‚   â³     â”‚  â”‚   â³     â”‚   â”‚
â”‚  â”‚  æ–‡æ¡£æ•°æ®  â”‚  â”‚  å‘é‡æ•°æ®  â”‚  â”‚  ç¼“å­˜    â”‚  â”‚  æ¶ˆæ¯é˜Ÿåˆ— â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3.9 -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶æ¨¡æ¿å¹¶åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cp env_template.txt .env
```

ç„¶åç¼–è¾‘ `.env`ï¼Œä¸»è¦é…ç½®é¡¹ï¼š

```bash
# ==================== AI æ¨¡å‹é…ç½® ====================
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_DEFAULT_MODEL=llama3.2
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_BASE_URL=https://api.deepseek.com

# è¿è¡Œæ¨¡å¼ï¼ˆæ§åˆ¶ Embedding å’Œ Reranker çš„è®¾å¤‡ï¼‰
RUNNING_MODE=cpu  # å¯é€‰: cpu, cuda, mps, gpu, auto

# HuggingFace æ¨¡å‹é…ç½®ï¼ˆé¿å…è”ç½‘æ£€æŸ¥ï¼‰ğŸ†•
TRANSFORMERS_OFFLINE=1  # ä½¿ç”¨æœ¬åœ°ç¼“å­˜
HF_HUB_OFFLINE=1        # ç¦ç”¨åœ¨çº¿æ£€æŸ¥
# HF_ENDPOINT=https://hf-mirror.com  # å¯é€‰ï¼šä½¿ç”¨é•œåƒ

# ==================== æ•°æ®åº“é…ç½® ====================
# MongoDB
MONGODB_URL=mongodb://root:rootpassword@localhost:27017/
MONGODB_DATABASE=rag_platform

# Milvus å‘é‡æ•°æ®åº“
MILVUS_HOST=localhost
MILVUS_PORT=19530
MILVUS_USER=root
MILVUS_PASSWORD=rootpassword
MILVUS_DB_NAME=rag_platform

# Redis ç¼“å­˜ ğŸ†•
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=  # å¯é€‰

# ==================== å…¶ä»–é…ç½® ====================
# Token é™åˆ¶é…ç½®ï¼ˆç”¨äºèŠå¤©å†å²æ€»ç»“ï¼‰
MAX_TOKEN_LIMIT_FOR_SUMMARY=6400
```

### 3. å¯åŠ¨æ•°æ®åº“æœåŠ¡

```bash
# å¯åŠ¨ Milvusï¼ˆå‘é‡æ•°æ®åº“ï¼‰
cd milvus
docker-compose up -d

# è®¿é—® Attu å¯è§†åŒ–ç•Œé¢
# http://localhost:8000

# å¯åŠ¨ Redisï¼ˆç¼“å­˜æœåŠ¡ï¼‰ğŸ†•
docker run -d --name redis -p 6379:6379 redis:latest

# æˆ–è€…ä½¿ç”¨æŒä¹…åŒ–
docker run -d --name redis \
  -p 6379:6379 \
  -v redis_data:/data \
  redis:latest redis-server --appendonly yes
```

### 4. ä¸‹è½½æ¨¡å‹ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰ğŸ†•

```bash
# Ollama æ¨¡å‹
ollama pull llama3.2

# HuggingFace æ¨¡å‹ï¼ˆä¼šè‡ªåŠ¨ä¸‹è½½åˆ° ~/.cache/huggingface/ï¼‰
# é¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ä¸‹è½½ï¼Œæˆ–è€…æ‰‹åŠ¨ï¼š
python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('BAAI/bge-large-zh-v1.5')"
python -c "from FlagEmbedding import FlagReranker; FlagReranker('BAAI/bge-reranker-v2-m3')"

# ä¸‹è½½å®Œæˆåï¼Œåœ¨ .env ä¸­è®¾ç½®ç¦»çº¿æ¨¡å¼
TRANSFORMERS_OFFLINE=1
HF_HUB_OFFLINE=1
```

### 5. å¯åŠ¨ API æœåŠ¡å™¨ ğŸ†•

```bash
# å¯åŠ¨ FastAPI æœåŠ¡å™¨
python main.py

# æœåŠ¡å™¨å°†åœ¨ http://localhost:8000 å¯åŠ¨
# è®¿é—® API æ–‡æ¡£ï¼šhttp://localhost:8000/docs
```

### 6. æµ‹è¯• API æ¥å£ ğŸ†•

```bash
# æµ‹è¯•ç”¨æˆ·ç®¡ç† API
python test/test_user_api.py

# æµ‹è¯•æ–‡æ¡£ç®¡ç† API
python test/test_document_api.py

# æµ‹è¯•ä¼šè¯ç®¡ç† API
python test/test_session_api.py

# æµ‹è¯•æµå¼æ¶ˆæ¯ APIï¼ˆæ¨èï¼‰â­
python test/test_message_api.py
# é€‰æ‹©æ¨¡å¼:
#   1. è‡ªåŠ¨æµ‹è¯•
#   2. äº¤äº’å¼èŠå¤©ï¼ˆéšè—æ€è€ƒè¿‡ç¨‹ï¼‰
#   3. äº¤äº’å¼èŠå¤©ï¼ˆæ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹ï¼‰â­
```

### 7. è¿è¡Œ RAG QA æ¼”ç¤ºï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰

```bash
# é¦–æ¬¡è¿è¡Œï¼šå¤„ç†æ–‡æ¡£å¹¶å­˜å‚¨
python test/test_full_rag_qa.py

# åç»­è¿è¡Œï¼šæ³¨é‡Šæ‰æ–‡æ¡£å¤„ç†æ­¥éª¤
# åœ¨ test_full_rag_qa.py çš„ main() å‡½æ•°ä¸­æ³¨é‡Šæ‰ï¼š
# success = await process_and_store_documents(doc_folder, collection_name)

# äº¤äº’å¼å‘½ä»¤ï¼š
# - è¾“å…¥é—®é¢˜è¿›è¡Œæé—®
# - 'history': æŸ¥çœ‹å†å²è®°å½•
# - 'clear': æ¸…ç©ºå†å²
# - 'exit' æˆ– 'quit': é€€å‡º
```

---

## ğŸ“Š Rerank åˆ†æ•°è¯´æ˜

BGE Reranker è¾“å‡ºçš„æ˜¯ **logits**ï¼ˆæœªå½’ä¸€åŒ–åˆ†æ•°ï¼‰ï¼š

- **èŒƒå›´**: é€šå¸¸åœ¨ `-10` åˆ° `+10` ä¹‹é—´
- **è§„åˆ™**: **åˆ†æ•°è¶Šé«˜ï¼Œç›¸å…³æ€§è¶Šå¼º**
- **ç¤ºä¾‹**:
  ```
  -0.39  â† æœ€ç›¸å…³ï¼ˆæœ€é«˜åˆ†ï¼‰
  -1.08  â† ç¬¬äºŒç›¸å…³
  -4.02  â† ç¬¬ä¸‰ç›¸å…³
  -6.12  â† ç›¸å…³æ€§è¾ƒä½
  ```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
plantform/
â”œâ”€â”€ api/                    # API è·¯ç”± âœ… ğŸ†•
â”‚   â””â”€â”€ v1/
â”‚       â”œâ”€â”€ user_info_controller.py   # ç”¨æˆ·ç®¡ç† API
â”‚       â”œâ”€â”€ document_controller.py    # æ–‡æ¡£ç®¡ç† API
â”‚       â”œâ”€â”€ session_controller.py     # ä¼šè¯ç®¡ç† API
â”‚       â”œâ”€â”€ message_controller.py     # æ¶ˆæ¯ç®¡ç† APIï¼ˆæµå¼ï¼‰
â”‚       â”œâ”€â”€ response_controller.py    # ç»Ÿä¸€å“åº”æ ¼å¼
â”‚       â””â”€â”€ __init__.py
â”œâ”€â”€ internal/               # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ âœ…
â”‚   â”œâ”€â”€ db/                 # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ mongodb.py      # MongoDBï¼ˆBeanie ODMï¼‰âœ…
â”‚   â”‚   â”œâ”€â”€ milvus.py       # Milvus å‘é‡æ•°æ®åº“ âœ…
â”‚   â”‚   â”œâ”€â”€ milvus_config.py # Milvus ä¼˜åŒ–é…ç½® âœ…
â”‚   â”‚   â””â”€â”€ redis.py        # Redis ç¼“å­˜ âœ… ğŸ†•
â”‚   â”œâ”€â”€ model/              # æ•°æ®æ¨¡å‹ âœ…
â”‚   â”‚   â”œâ”€â”€ document.py     # æ–‡æ¡£æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ message.py      # æ¶ˆæ¯æ¨¡å‹ï¼ˆå¸¦ session_idï¼‰ğŸ†•
â”‚   â”‚   â”œâ”€â”€ session.py      # ä¼šè¯æ¨¡å‹ ğŸ†•
â”‚   â”‚   â””â”€â”€ user_info.py    # ç”¨æˆ·æ¨¡å‹
â”‚   â”œâ”€â”€ dto/                # æ•°æ®ä¼ è¾“å¯¹è±¡ âœ… ğŸ†•
â”‚   â”‚   â”œâ”€â”€ request/        # è¯·æ±‚ DTO
â”‚   â”‚   â”‚   â”œâ”€â”€ user_request.py
â”‚   â”‚   â”‚   â”œâ”€â”€ message_request.py
â”‚   â”‚   â”‚   â”œâ”€â”€ session_request.py
â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ respond/        # å“åº” DTO
â”‚   â”‚       â”œâ”€â”€ user_response.py
â”‚   â”‚       â”œâ”€â”€ document_response.py
â”‚   â”‚       â”œâ”€â”€ session_response.py
â”‚   â”‚       â”œâ”€â”€ message_response.py
â”‚   â”‚       â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ service/            # ä¸šåŠ¡é€»è¾‘å±‚ âœ… ğŸ†•
â”‚   â”‚   â””â”€â”€ orm/
â”‚   â”‚       â”œâ”€â”€ user_info_sever.py    # ç”¨æˆ·ç®¡ç†æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ document_sever.py     # æ–‡æ¡£ç®¡ç†æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ session_sever.py      # ä¼šè¯ç®¡ç†æœåŠ¡
â”‚   â”‚       â””â”€â”€ message_sever.py      # æ¶ˆæ¯ç®¡ç†æœåŠ¡ï¼ˆæµå¼ï¼‰
â”‚   â”œâ”€â”€ http_sever/         # HTTP æœåŠ¡ âœ… ğŸ†•
â”‚   â”‚   â”œâ”€â”€ app.py          # FastAPI åº”ç”¨å·¥å‚
â”‚   â”‚   â””â”€â”€ routes.py       # è·¯ç”±æ³¨å†Œ
â”‚   â”œâ”€â”€ llm/                # LLM æœåŠ¡ âœ…
â”‚   â”‚   â””â”€â”€ llm_service.py  # ç»Ÿä¸€ LLM æ¥å£ï¼ˆç®€åŒ– APIï¼‰ğŸ†•
â”‚   â”œâ”€â”€ chat_service/       # ä¼šè¯æœåŠ¡ âœ… ğŸ†•
â”‚   â”‚   â”œâ”€â”€ chat_service.py # ChatServiceï¼ˆSession + Redis + Agentï¼‰
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ agent/              # ReAct Agent âœ… ğŸ†•
â”‚   â”‚   â”œâ”€â”€ react_agent.py  # ReAct Agent å®ç°ï¼ˆæ”¯æŒå›è°ƒï¼‰
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ embedding/          # Embedding æœåŠ¡ âœ…
â”‚   â”‚   â””â”€â”€ embedding_service.py
â”‚   â”œâ”€â”€ reranker/           # Reranker æœåŠ¡ âœ…
â”‚   â”‚   â””â”€â”€ reranker_service.py
â”‚   â”œâ”€â”€ document/           # æ–‡æ¡£å¤„ç† âœ…
â”‚   â”‚   â””â”€â”€ document_processor.py
â”‚   â”œâ”€â”€ rag/                # RAG æœåŠ¡ âœ…
â”‚   â”‚   â””â”€â”€ rag_service.py
â”‚   â”œâ”€â”€ document_client/    # æ–‡æ¡£å¤„ç†å®¢æˆ·ç«¯ âœ… ğŸ†•
â”‚   â”‚   â”œâ”€â”€ config.toml     # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ config_loader.py
â”‚   â”‚   â”œâ”€â”€ document_processor.py
â”‚   â”‚   â”œâ”€â”€ message_client.py
â”‚   â”‚   â”œâ”€â”€ channel/        # å†…å­˜é˜Ÿåˆ—
â”‚   â”‚   â””â”€â”€ Kafka/          # Kafka å®¢æˆ·ç«¯
â”‚   â””â”€â”€ Kafka/              # Kafka éƒ¨ç½² âœ… ğŸ†•
â”‚       â””â”€â”€ docker-compose.yml
â”œâ”€â”€ pkg/                    # å…¬å…±ç»„ä»¶ âœ…
â”‚   â”œâ”€â”€ model_list/         # ç»Ÿä¸€æ¨¡å‹ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ base_model.py           # åŸºç¡€æ¨¡å‹ç±»
â”‚   â”‚   â”œâ”€â”€ llm_model_list.py       # LLM æ¨¡å‹é…ç½®
â”‚   â”‚   â”œâ”€â”€ embedding_model_list.py # Embedding æ¨¡å‹é…ç½®
â”‚   â”‚   â”œâ”€â”€ reranker_model_list.py  # Reranker æ¨¡å‹é…ç½®
â”‚   â”‚   â””â”€â”€ model_manager.py        # æ¨¡å‹ç®¡ç†å™¨
â”‚   â”œâ”€â”€ agent_prompt/       # Prompt ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ prompt_templates.py     # Prompt æ¨¡æ¿
â”‚   â”‚   â””â”€â”€ agent_tool.py           # å·¥å…·å®šä¹‰
â”‚   â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•° âœ… ğŸ†•
â”‚   â”‚   â”œâ”€â”€ password_utils.py       # å¯†ç åŠ å¯†
â”‚   â”‚   â”œâ”€â”€ jwt_utils.py            # JWT è®¤è¯
â”‚   â”‚   â”œâ”€â”€ email_service.py        # é‚®ä»¶æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ document_utils.py       # æ–‡æ¡£å¤„ç†
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â””â”€â”€ constants/          # å…¨å±€å¸¸é‡
â”‚       â””â”€â”€ constants.py
â”œâ”€â”€ log/                    # æ—¥å¿—ç³»ç»Ÿ âœ… ğŸ†•
â”‚   â”œâ”€â”€ logger.py           # Loguru æ—¥å¿—é…ç½®
â”‚   â””â”€â”€ json_log/           # JSON æ—¥å¿—ç›®å½•ï¼ˆæŒ‰æ—¥æœŸï¼‰
â”œâ”€â”€ test/                   # æµ‹è¯•æ–‡ä»¶ âœ…
â”‚   â”œâ”€â”€ test_mongodb.py
â”‚   â”œâ”€â”€ test_milvus.py
â”‚   â”œâ”€â”€ test_redis.py         # Redis æµ‹è¯• ğŸ†•
â”‚   â”œâ”€â”€ test_rag.py
â”‚   â”œâ”€â”€ test_summary_mechanism.py # å»¶è¿Ÿæ€»ç»“æœºåˆ¶æµ‹è¯• ğŸ†•
â”‚   â”œâ”€â”€ test_chat_service.py  # ChatService æµ‹è¯• ğŸ†•
â”‚   â”œâ”€â”€ test_full_rag_qa.py   # å®Œæ•´ RAG QA æ¼”ç¤ºï¼ˆChatService + Agentï¼‰ğŸ†•
â”‚   â”œâ”€â”€ test_user_api.py      # ç”¨æˆ· API æµ‹è¯• ğŸ†•
â”‚   â”œâ”€â”€ test_document_api.py  # æ–‡æ¡£ API æµ‹è¯• ğŸ†•
â”‚   â”œâ”€â”€ test_session_api.py   # ä¼šè¯ API æµ‹è¯• ğŸ†•
â”‚   â”œâ”€â”€ test_message_api.py   # æµå¼æ¶ˆæ¯ API æµ‹è¯• ğŸ†• â­
â”‚   â”œâ”€â”€ test_password_utils.py # å¯†ç å·¥å…·æµ‹è¯• ğŸ†•
â”‚   â”œâ”€â”€ test_jwt_utils.py     # JWT å·¥å…·æµ‹è¯• ğŸ†•
â”‚   â””â”€â”€ test_email_service.py # é‚®ä»¶æœåŠ¡æµ‹è¯• ğŸ†•
â”œâ”€â”€ milvus/                 # Milvus éƒ¨ç½² âœ…
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ mongodb/                # MongoDB éƒ¨ç½² âœ… ğŸ†•
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ main.py                 # åº”ç”¨å…¥å£ï¼ˆFastAPIï¼‰âœ… ğŸ†•
â”œâ”€â”€ requirements.txt        # Python ä¾èµ– âœ…
â”œâ”€â”€ .env                    # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ .gitignore              # Git å¿½ç•¥è§„åˆ™ âœ…
â”œâ”€â”€ API_DEVELOPMENT_GUIDE.md # API å¼€å‘æŒ‡å— ğŸ†•
â””â”€â”€ README.md               # æœ¬æ–‡ä»¶
```

---

## ğŸ”§ å¸¸ç”¨å‘½ä»¤

### æ•°æ®åº“ç®¡ç†

```bash
# æŸ¥çœ‹ Milvus é›†åˆ
docker exec milvus milvus_cli list collections

# è¿æ¥ MongoDB
mongosh mongodb://root:rootpassword@localhost:27017/
```

### æ¨¡å‹ç®¡ç†

```bash
# æŸ¥çœ‹å·²ä¸‹è½½çš„ Ollama æ¨¡å‹
ollama list

# æ‹‰å– Ollama æ¨¡å‹
ollama pull llama3.2

# è¿è¡Œ Ollama æ¨¡å‹æµ‹è¯•
ollama run llama3.2
```

---

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

### 1. æ¨¡å‹é…ç½® ğŸ†•
- æ‰€æœ‰æ¨¡å‹é…ç½®ç»Ÿä¸€åœ¨ `pkg/model_list/` ä¸­ç®¡ç†
- ä½¿ç”¨ `ModelManager` è¿›è¡Œæ¨¡å‹é€‰æ‹©å’Œåˆå§‹åŒ–
- é¿å…ç¡¬ç¼–ç æ¨¡å‹åç§°ï¼Œä½¿ç”¨é…ç½®å¸¸é‡ï¼ˆå¦‚ `BGE_LARGE_ZH_V1_5.name`ï¼‰
- **å¯¼å…¥é¡ºåº**ï¼šç¡®ä¿ `constants.py` åœ¨ HuggingFace åº“ä¹‹å‰å¯¼å…¥
- **ç¦»çº¿æ¨¡å¼**ï¼šè®¾ç½® `TRANSFORMERS_OFFLINE=1` å’Œ `HF_HUB_OFFLINE=1`

### 2. æ¶æ„è®¾è®¡ ğŸ†•
- **LLMService**: ç®€åŒ– APIï¼Œæ”¯æŒ `user_message`ï¼ˆæ¨èï¼‰å’Œ `messages`ï¼ˆé«˜çº§ï¼‰
- **ChatService**: ç»Ÿä¸€å…¥å£ï¼Œè‡ªåŠ¨ç®¡ç† Sessionã€Redisã€å†å²è®°å½•
- **ReAct Agent**: ç”± ChatService åˆ›å»ºå’Œç®¡ç†ï¼Œä¸ç›´æ¥ä½¿ç”¨
- **ç»Ÿä¸€çš„ chat() æ–¹æ³•**: æ”¯æŒæ™®é€šå¯¹è¯å’Œ Agent å¯¹è¯
- **æ¨èç”¨æ³•**ï¼š
  ```python
  # âœ… æ¨èï¼šä½¿ç”¨ ChatService ç»Ÿä¸€ API
  # æ™®é€šå¯¹è¯
  for chunk in chat_service.chat("ä½ å¥½"):
      print(chunk, end="")
  
  # Agent å¯¹è¯ï¼ˆå·¥å…·è°ƒç”¨ï¼‰
  answer = chat_service.chat(
      user_message="é—®é¢˜",
      use_agent=True,
      agent_tools={"knowledge_search": knowledge_search},
      save_only_answer=True  # åªä¿å­˜é—®ç­”
  )
  
  # âŒ ä¸æ¨èï¼šç›´æ¥ä½¿ç”¨ Agent
  # agent = create_react_agent(llm, tools)
  # answer = agent.run(question)
  ```

### 3. æ•°æ®åº“æ“ä½œ
- MongoDB ä½¿ç”¨ Beanie ODM å¼‚æ­¥æ“ä½œ
- Milvus é›†åˆéœ€è¦å…ˆ `flush()` å† `load()` æ‰èƒ½æœç´¢
- å‘é‡ç»´åº¦å¿…é¡»ä¸ Embedding æ¨¡å‹è¾“å‡ºä¸€è‡´ï¼ˆ1024ç»´ï¼‰
- Redis ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œè‡ªåŠ¨è¿æ¥ç®¡ç†

### 4. RAG æ£€ç´¢
- Reranker åˆ†æ•°é˜ˆå€¼é»˜è®¤ä¸º `-100.0`ï¼ˆå› ä¸ºæ˜¯ logitsï¼‰
- å»é‡é˜ˆå€¼ä¸º `0.02`ï¼ˆç›¸ä¼¼åº¦ 98%ï¼‰
- å»ºè®®æ£€ç´¢ Top-15ï¼ŒRerank åè¿”å› Top-5
- `knowledge_search` å·¥å…·çš„ `max_context_length` å·²å¢è‡³ 10000

### 5. æ€§èƒ½ä¼˜åŒ–
- Embedding å’Œ Reranker æœåŠ¡ä½¿ç”¨å•ä¾‹æ¨¡å¼
- å‘é‡æ£€ç´¢ä½¿ç”¨ COSINE ç›¸ä¼¼åº¦
- å¤§æ–‡æ¡£å»ºè®® chunk_size=500, chunk_overlap=50
- æ™ºèƒ½è®¾å¤‡é€‰æ‹©ï¼šè‡ªåŠ¨æ£€æµ‹ CUDA/MPSï¼Œæˆ–æ‰‹åŠ¨è®¾ç½® `RUNNING_MODE`

### 6. å†å²è®°å½•ç®¡ç† ğŸ†•
- **ChatService è‡ªåŠ¨ç®¡ç†**ï¼šæ— éœ€æ‰‹åŠ¨è°ƒç”¨ `add_to_history` æˆ– `sync_to_redis`
- **å»¶è¿Ÿæ€»ç»“**ï¼šåœ¨ä¸‹æ¬¡å¯¹è¯å‰æ‰§è¡Œï¼Œä¸é˜»å¡å½“å‰å¯¹è¯
- **å¯æ§ç²’åº¦**ï¼š`save_only_answer=True` åªä¿å­˜é—®ç­”ï¼ˆæ¨èï¼Œç®€æ´ï¼‰
- **Session éš”ç¦»**ï¼šæ¯ä¸ª Session ç‹¬ç«‹çš„å†å²è®°å½•å’Œ Redis é”®

### 7. ä»£ç é‡ç”¨ä¸ DRY ğŸ†•
- é¿å…é‡å¤ä»£ç ï¼šä½¿ç”¨ `_normalize_chunk()` ç»Ÿä¸€å¤„ç†ä¸åŒæ¨¡å‹è¿”å›å€¼
- å‚æ•°éªŒè¯ï¼šç¦æ­¢åŒæ—¶ä¼ é€’å†²çªå‚æ•°ï¼ˆå¦‚ `user_message` å’Œ `messages`ï¼‰
- ä¾èµ–æ³¨å…¥ï¼šä½¿ç”¨å‚æ•°ä¼ é€’ä¾èµ–ï¼ˆå¦‚ `document_processor`ï¼‰ï¼Œé¿å…å¾ªç¯å¯¼å…¥
